load("@rules_msbuild//dotnet:defs.bzl", "msbuild_binary")

filegroup(
    name = "builder_srcs",
    srcs = [
        "BazelLogger.cs",
        "BazelPropsWriter.cs",
        "BuildContext.cs",
        "Builder.cs",
        "Caching/BuildCache.cs",
        "Caching/BuildResult.cs",
        "Caching/CacheManifest.cs",
        "Caching/Label.cs",
        "Caching/LabelResult.cs",
        "Command.cs",
        "Diagnostics/Debugger.cs",
        "Diagnostics/GraphViz/DotWriter.cs",
        "Diagnostics/GraphViz/IStyler.cs",
        "Diagnostics/TargetGraph.cs",
        "Diagnostics/TargetGraphLogger.cs",
        "Files.cs",
        "Launcher/LaunchDataWriter.cs",
        "Launcher/LauncherFactory.cs",
        "MSBuild/BazelMsBuildLogger.cs",
        "MSBuild/BuildManagerFields.cs",
        "MSBuild/MSBuildContext.cs",
        "MSBuild/MsBuildCacheManager.cs",
        "MSBuild/Serialization.cs",
        "OutputProcessor.cs",
        "PathMapper.cs",
        "Program.cs",
        "ProjectLoader.cs",
    ],
    visibility = ["//visibility:public"],
)

exports_files(["Builder.csproj"])

msbuild_binary(
    name = "Builder",
    srcs = [
        "BazelLogger.cs",
        "BazelPropsWriter.cs",
        "BuildContext.cs",
        "Builder.cs",
        "Caching/BuildCache.cs",
        "Caching/BuildResult.cs",
        "Caching/CacheManifest.cs",
        "Caching/Label.cs",
        "Caching/LabelResult.cs",
        "Command.cs",
        "Diagnostics/Debugger.cs",
        "Diagnostics/GraphViz/DotWriter.cs",
        "Diagnostics/GraphViz/IStyler.cs",
        "Diagnostics/TargetGraph.cs",
        "Diagnostics/TargetGraphLogger.cs",
        "Files.cs",
        "Launcher/LaunchDataWriter.cs",
        "Launcher/LauncherFactory.cs",
        "MSBuild/BazelMsBuildLogger.cs",
        "MSBuild/BuildManagerFields.cs",
        "MSBuild/MSBuildContext.cs",
        "MSBuild/MsBuildCacheManager.cs",
        "MSBuild/Serialization.cs",
        "OutputProcessor.cs",
        "PathMapper.cs",
        "Program.cs",
        "ProjectLoader.cs",
    ],
    project_file = "Builder.csproj",
    target_framework = "net5.0",
    visibility = ["//:__subpackages__"],
    deps = [
        "@nuget//CommandLineParser",
        "@nuget//Microsoft.Build.Locator",
        # gazelle-err: unsupported attribute: ExcludeAssets
        "@nuget//Microsoft.Build.Utilities.Core",
        # gazelle-err: unsupported attribute: ExcludeAssets
        # gazelle-err: unsupported attribute: GeneratePathProperty
        "@nuget//SamHowes.Microsoft.Build",
    ],
)
